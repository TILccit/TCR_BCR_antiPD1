This repository contains the scripts used for the analysis of the research paper titled "___Intratumoral T-cell and B-cell receptor architecture associates with distinct immune tumor microenvironment features and clinical outcomes of anti-PD-1/L1 immunotherapy___". 

The purpose of this repository is to provide the scripts that analyze the data, generate key tables, and produce some of the main and supplementary figures and files mentioned in the paper.

- - - -

## **Folder Structure** ##

* data: This folder contains all the input data files used in the analysis. The relevant datasets and input files can be found here.
* docs: This folder contains additional documentation or supplementary materials related to the analysis. Any additional resources, such as data dictionaries or metadata, can be found here.
* output: The "outputs" folder contains the outputs generated by the scripts. It is organized into the following subfolders:
	* data_files: Intermediate or processed data files are stored here. These files are generated during the analysis and serve as inputs for subsequent steps.
	* figures: The figures generated during the analysis are saved in this subfolder. These figures include the main and supplementary figures mentioned in the paper created using the main scripts. Figures not included are created with different tools such as GraphPad as mentioned in the paper.
	* tables: The tables generated during analysis are saved in this subfolder. These tables include the main and supplementary tables mentioned in the paper created using the main scripts. Tables not included are created with different tools.
	* models: The models generated during analysis are saved in this folder
* scripts: The "scripts" folder contains the R scripts used for the analysis. It is organized into the following subfolders:
	* main: This subfolder contains the main R Markdown scripts that drive the analysis workflow. These scripts provide a step-by-step process for reproducing the analysis described in the paper. The style.css file is automatically used and necessary for the steyle/design of the R markdown files and reports.
	* functions: All custom R scripts with functions used in the analysis are stored in this subfolder. These functions are called by the main scripts for various calculations and data manipulations.
* session_info: The "session_info" folder holds the SessionInfo.txt files for each analysis. Each subfolder within "session_info" corresponds to a specific analysis, storing the respective SessionInfo.txt file.
* tools: necessary tools to run the analyses. Here, we include a folder with the CIBERSORT R script to run the analytical tool and the LM22 signature matrix file; The CIBERSORT.R code can be downloaded from https://cibersortx.stanford.edu/download.php

**Note on empty folders** 

* Data folders (input) are empty since some of the raw data that support the findings of our study are restricted. For any further inquiries or clarifications, please contact **Marco Donia, M.D., Ph.D** at _marco.donia@regionh.dk_. Details on how the raw data were processed are included in the manuscript.
* Empty docs folders: there were no additional files required for the analyses and the study.
* Empty tools folder: in order to be able to download the CIBERSORT R script and LM22 signature matrix file, any user must first register and request access [here](https://cibersortx.stanford.edu/). The LM22 signature file used in our analyses has been updated to match gene symbols in our data.
- - - -

## **Instructions** ##

To reproduce the analysis conducted in the paper, please follow these steps:
1.	Clone or download this repository to your local machine.
2.	Navigate to the "data" folder and ensure that all the required data files are present. These files serve as the input for the analysis scripts.
3.	Open the R Markdown scripts located in the "scripts/main" folder. These scripts outline the analysis workflow and provide instructions for reproducing the results.
4.	Ensure that the necessary R packages are installed and up to date. Refer to the SessionInfo.txt files within the respective "session_info" subfolders for the specific package versions used during each analysis.
5.	Set the working directory within each R Markdown script to the root folder of this project. This ensures that the relative paths to the data files and other resources are correctly resolved. Make sure that the default directory of all the chunks is set to the one also used in the console (change via global options). For knitting the .RMD file, change the root directory in the knit setup chunk at the top of the document. More details below
6.	Execute the R Markdown scripts in the specified order, following the instructions and guidelines provided within each script.
7.	The outputs, including tables, figures and models, will be generated and stored in the "output" folder. Refer to the generated outputs for the corresponding results mentioned in the paper. See information below on where to find supplemental files.

**Note**: The comprehensive repository, inclusive of all input and output data, requires approximately 101 GB of disk space.

- - - -

## **Blocks of analysis - Order of running the scripts** ##

**IMPORTANT - BEFORE RUNNING THE SCRIPTS**
1. For all Rmarkdown documents, clear the cache before knitting by clicking on the "Clear Knitr Cache" button in the RStudio toolbar.
2. Before running each script or block of scripts individually, ensure you initiate a new R session.
3. Please configure the **projectDir** and **root.dir** parameters within each script to reflect the absolute path where the repository folder is stored.

### **[A] TCGA data preprocessing and preparation** ###

Block A scripts running all TCGA data download and processing needs to be run with administrative rights. 

1. _A_01_download_tcga_rsem.R_: Due to changes in the releases of concrete TCGA Cohorts of cancer types, despite set release date, the downloaded data are different from those we accessed and used for the analysis. Please contact us to get the TCGA RSEM input data used in the manuscript.
2. _A_02_download_tcga_htseq.R_: due to changes in the TCGAbiolinks, this code is no longer working. Please contact us to get the HTSEQ count and FPKM-UQ input data used in the manuscript.
3. _A_03_get_vst_normalized.R_: vst normalization of TCGA count data
4. _A_04_get_TCGA_msi_status_data.R_: due to archiving of GDC legacy data (see [here](https://gdc.cancer.gov/news-and-announcements/gdc-legacy-archive-retires)), this script is no longer working. Downloaded MSI data are provided in the TCGA input data folder.
5. _A_05_get_TCGA_biospecimen_RNA.RMD_: gather and filter all TCGA biospecimen data
6. _A_06_tcga_clinical_biomarker_metadata.RMD_: Gather table of clinical, biomarker metadata for TCGA samples

These scripts can be executed individually, following the specified order, or directly from the  __A_TCGA_data_preparation.R__ script, encompassing the entire code collection for block A.

### **[B] anti-PD(L)1 data preprocessing and preparation** ###

Block B scripts for all anti-PD(L)1 datasets processing. 

1. _B_01_aPD1_data_count_deconvolution_processing.RMD_: normalization of count data, immune cell deconvolution using CIBERSORT
2. _B_02_aPD1_TCR_BCR_clones_analysis.RMD_: processing of TCR, BCR clone counts
3. _B_03_aPD1_merge_ready_data.R_: Merging of clinical, biomarker metadata for anti-PD(L)1 datasets

These scripts can be executed individually, following the specified order, or directly from the __B_antiPD(L)1_data_preparation.R__ script, encompassing the entire code collection for block B.

### **[C] Survival analysis** ###

Block C scripts for the survival analyses included in the paper. 

1. _C_01_TCGA_survival_analysis.RMD_: Uni and Multivariate survival analysis for TCGA data
2. _C_01_TCGA_survival_analysis.RMD_: Uni and Multivariate survival analysis for anti-PD(L)1 public and restricted data
3. _C_03_TCGA_survival_KMplots.R_: Univariate survival analysis and KM plots for TCGA data
4. _C_04_aPD1_survival_KMplots.R_: Univariate survival analysis and KM plots for anti-PD(L)1 public and restricted data

These scripts can be executed individually, following the specified order, or directly from the __C_Survival_analyses.R__ script, encompassing the entire code collection for block C.

### **[D] Differential expression analysis, GEO enrichment and similarity analyses** ###

Block D script for the differential expression analysis and GEO enrichment included in the paper. 

1. _D_01_DEA_GOenrich_TCGA.RMD_: Perform Differential expression analysis on TCGA data, then GO enrichment analysis.

The script can be executed from the __D_DEA_GOsimilarity_analyses.R__ script, encompassing the entire code collection for block D.

**Note**: GO similarity analysis is performed in Block F

### **[E] Predictive modeling** ###

Block E scripts for performing the predictive modelling of response to anti-PD(L)1 using biomarkers included in the paper. 

1. _E_01_aPD1_RFE_multivariate_Scheme_1.R_ :  Running the models for Scheme 1
2. _E_02_aPD1_RFE_multivariate_Scheme_2_BLADDER.R_: Running the models for Scheme 2
3. _E_03_aPD1_RFE_multivariate_Scheme_3_MELANOMA.R_: Running the models for Scheme 3
4. _E_04_aPD1_RFE_multivariate_postProcessing_Scheme1.RMD_: post-processing of RFE modeling results, logistic regression models, ROC-AUC comparisons for SCHEME 1
5. _E_05_aPD1_RFE_multivariate_postProcessing_Scheme2.RMD_: post-processing of RFE modeling results, logistic regression models, ROC-AUC comparisons for SCHEME 2 (BLCA specific)
6. _E_06_aPD1_RFE_multivariate_postProcessing_Scheme3.RMD_: post-processing of RFE modeling results, logistic regression models, ROC-AUC comparisons for SCHEME 3 (SKCM specific)
7. _E_07_MissingData.RMD_: exploring missing data in the anti-PD-1/L1 datasets, producing Supplemental Figure S2

**Info**: 
* Scripts 1-3 were executed in Computerome, utilizing 40 cores. Minor variations in results may occur based on the number of cores employed for parallelization. Each script demands a significant amount of computational time.
* Ensure you configure the projectDir parameter within the scripts to reflect the absolute path where the repository folder is stored.
* Scripts 1-3 can be executed from the command line interface (CLI) by providing an argument for the desired algorithm. Options for algorithms include LR, NB, RF, KNN, SVMr, SVMl, and single. Use "single" exclusively for extracting optimization parameters from different models, necessary step for downstream analyses. For instance, here's an example of how to run them in Computerome after requesting an interactive session (equivalent to submitting a job):
	
	````
	module load intel/perflibs/2020_update4 gcc/11.1.0 R/4.1.0 # Load necessary modules in Computerome
	Rscript ./E_02_aPD1_RFE_multivariate_Scheme_2_BLADDER.R LR	# Run R script from within the folder it is saved
	````
* Due to the substantial computational time required for executing scripts 1-3, the results of predictive modeling and corresponding outputs are available in the **output/models/** folder.
* Scripts 4-6 can be executed independently since predictive modelling results are saved in the output/models folder. It is suggested to run them first using run_clean set to TRUE, without knitting, running all chunks and then set run_clean set to FALSE to get the html report.

### **[F] Results in figures, tables, supplemental files** ###

Block F script for producing all main and supplemental figures except Supplemental Fig. S2), tables and data included in the paper. 

1. _F_paper_figures_tables_files.RMD_: producing all figures (except Supplemental Fig. S2) , tables and supplemental files provided in the manuscript.
- - - -

## **Note on Supplemental files** ##
For details on the content of supplemental files referenced in the paper and their locations within the GitHub project output folders can be found in the sections below.
Some supplemental PDF files are stored in the output/figures folder. Others can be found in the output/tables folder.

The **Transparent reporting of a multivariable prediction model for individual prognosis or diagnosis (TRIPOD)** checklist statement submitted for reporting the development and validation of our prediction models, is included in the __docs/__ folder.

### __Excel files saved in output/data_files__ ###

* Supplemental File 1: Biomarkers pairwise Spearman's correlations- pancancer, multicancer, individual cohorts (jitc-2023-006941supp001)
* Supplemental File 2: Differentially expressed genes - BCR, PDL1, CD8 in SKCM, KIRC, BLCA, STAD cohorts (jitc-2023-006941supp002)
* Supplemental File 3: A. Gene ontology biological processes (BP) focused set, including annotations of all GO annotation offsprings, B. Gene ontology biological processes associated with the differentially upregulated genes in i) BCR Richness high samples compared to BCR Richness low samples,  ii) in PD-L1 expression high samples compared to PD-L1 expression low samples, iii) in CD8+ T-cells infiltration high samples compared to CD8+ T-cells infiltration low samples for the SKCM, KIRC, BLCA, STAD cohorts (jitc-2023-006941supp003)
* Supplemental File 4: ROC-AUC values of univariable models of established biomarkers, TCR richness, BCR richness compared to the bivariable and multivariable models in histology non specific scheme (1), BLCA-specific (2), SKCM-specific (3) (jitc-2023-006941supp004)


### __Supplemental Files saved as in output/figures__ ###

* Supplemental File 6 - Online Supplemental Figure S2: Missigness analysis of anti-PD-L-1 public data cohorts (jitc-2023-006941supp006)
* Supplemental File 7- Online Supplemental Figure S3: Individual four-type multicancer correlations (jitc-2023-006941supp007)
* Supplemental File 8- Online Supplemental Figure S4: Gene ontology (GO) dotplots of the significantly enriched GO biological processes, contrast setting of high versus low PDL1/CD8 infiltration (jitc-2023-006941supp008)
* Supplemental File 9- Online Supplemental Figure S5: Objective response rate correlations with median logTMB, PD-L1 expression, TIS-GEP, CD8+, CD4+ T-cells, B cells infiltration, tumor purity across 26 TCGA tumor types (jitc-2023-006941supp009)
* Supplemental File 10- Online Supplemental Figure S6: Univariable Cox proportional hazards analysis  - KM plots for TCR and BCR richness (jitc-2023-006941supp010)
* Supplemental File 11- Online Supplemental Figure S7: Univariable Cox proportional hazards analysis  - KM plots for logTMB, PD-L1 expression, TIS-GEP (jitc-2023-006941supp011)
* Supplemental File 12- Online Supplemental Figure S8: Univariable Cox proportional hazards analysis  - KM plots for CD8+, CD4+ T-cells, B cells infiltration, tumor purity(jitc-2023-006941supp012)
* Supplemental File 13- Online Supplemental Figure S9: Predictive modeling workflow (jitc-2023-006941supp013)
* Supplemental File 14- Online Supplemental Figure S10: ROC-AUC comparisons of uni and multivariate RFE models performance across schemes(jitc-2023-006941supp014)

**Note** on Suppl. Figure S10: 
Despite rigorous efforts to maintain consistency, including using the same R version, R package versions, and controlling for randomness in data sampling through bootstrapping (via set.seed()), the most recent execution of the code producing this figure resulted in slightly different p-values from the ROC-AUC comparisons. The variations, observed at the second and third decimal points, were extensively investigated through debugging, yet, without identifying a specific cause.
It is important to note that these differences are minimal and well within an acceptable range for our analysis. Importantly, the evaluation of significance when comparing the ROC-AUC values remains consistent, ensuring the integrity of our study's results and discussion.

### __Supplemental Files saved in output/tables__ ###
Supplemental File 15- Online Supplemental Tables S3-6: Supplementary Tables (jitc-2023-006941supp015)

### __Other supplemental files, not included in the output/ folder__ ###
Supplemental File 16: Supplementary methods (jitc-2023-006941supp016)

- - - -

Please note that reproducing the analysis may require sufficient computational resources and dependencies. In order to be able to run the scripts, several R packages need to be installed and loaded, details on the packages (incl. versions) are listed in the session_info files provided for each of the main scripts.

It is recommended to review the documentation and understand the workflow before running the scripts.

- - - -
For any further inquiries or clarifications, please contact **Marco Donia, M.D., Ph.D** at _marco.donia@regionh.dk_.
- - - -

## **Citation**  ##

Please acknowledge the original authors of the paper and cite the appropriate references when using or building upon this work.
If you use the code or findings from this project in your research, please consider citing:

Schina, A., Sztupinszki, Z., Marie Svane, I., Szallasi, Z., Jönsson, G., & Donia, M. (2023). Intratumoral T-cell and B-cell receptor architecture associates with distinct immune tumor microenvironment features and clinical outcomes of anti-PD-1/L1 immunotherapy. Journal for immunotherapy of cancer, 11(8), e006941. https://doi.org/10.1136/jitc-2023-006941